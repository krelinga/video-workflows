openapi: 3.0.3
info:
  title: Disc Workflow Service
  description: API service for managing disc workflows
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.example.com
    description: Production server

paths:
  /activity/get_video_info/complete:
    post:
      summary: Complete the GetVideoInfo activity
      description: Completes the GetVideoInfo activity with the provided token
      operationId: CompleteGetVideoInfoActivity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompleteGetVideoInfoActivityRequest'
      responses:
        '200':
          description: Activity completed successfully
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /activity/transcode/complete:
    post:
      summary: Complete the Transcode activity
      description: Completes the Transcode activity with the provided token and completion percentage
      operationId: CompleteTranscodeActivity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompleteTranscodeActivityRequest'
      responses:
        '200':
          description: Activity completed successfully
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /activity/transcode/heartbeat:
    post:
      summary: Heartbeat for the Transcode activity
      description: Sends a heartbeat for the Transcode activity with the provided token and completion percentage
      operationId: TranscodeActivityHeartbeat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HeartbeatTranscodeActivityRequest'
      responses:
        '200':
          description: Activity completed successfully
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /disc:
    post:
      summary: Create a disc workflow
      description: Creates a new disc workflow with a client-provided UUID and directory path
      operationId: createDisc
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDiscRequest'
      responses:
        '201':
          description: Disc workflow created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiscWorkflow'
        '400':
          description: Bad request - the specified path does not exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict - the given UUID is already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /disc/{uuid}:
    get:
      summary: Get disc workflow status
      description: Returns the current state of a disc workflow by UUID
      operationId: getDisc
      tags:
        - disc
      parameters:
        - name: uuid
          in: path
          required: true
          description: UUID of the disc workflow
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Disc workflow found
          headers:
            Cache-Control:
              description: Disable caching for this endpoint
              schema:
                type: string
                example: no-cache, no-store, must-revalidate
            Pragma:
              description: HTTP 1.0 backward compatibility for cache control
              schema:
                type: string
                example: no-cache
            Expires:
              description: Expire immediately
              schema:
                type: string
                example: "0"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiscWorkflow'
        '404':
          description: Disc workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /inbox:
    get:
      summary: List inbox disc paths
      description: Returns a list of disc paths in the inbox
      operationId: getInbox
      tags:
        - disc
      responses:
        '200':
          description: List of inbox disc paths
          headers:
            Cache-Control:
              description: Disable caching for this endpoint
              schema:
                type: string
                example: no-cache, no-store, must-revalidate
            Pragma:
              description: HTTP 1.0 backward compatibility for cache control
              schema:
                type: string
                example: no-cache
            Expires:
              description: Expire immediately
              schema:
                type: string
                example: "0"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InboxResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    CompleteGetVideoInfoActivityRequest:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          format: byte
          description: Base64-encoded binary token
          example: dGVzdC10b2tlbi1kYXRh
        uuid:
          type: string
          format: uuid
          description: UUID that was used to start the GetVideoInfo activity.
          example: 550e8400-e29b-41d4-a716-446655440000
        result:
          $ref: '#/components/schemas/CompleteGetVideoInfoActivityRequestResult'
        error:
          type: string
          description: Error message if the activity failed
          example: Failed to retrieve video info due to network error

    CompleteGetVideoInfoActivityRequestResult:
      type: object
      properties:
        totalDurationSeconds:
          type: number
          format: double
          description: Total duration of the video in seconds
          example: 3600
        chapterDurationsSeconds:
          type: array
          items:
            type: number
            format: double
          description: List of chapter durations in seconds
          example: [600, 1200, 1800]
    
    CompleteTranscodeActivityRequest:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          format: byte
          description: Base64-encoded binary token
          example: dGVzdC10b2tlbi1kYXRh
        uuid:
          type: string
          format: uuid
          description: UUID that was used to start the transcode.
          example: 550e8400-e29b-41d4-a716-446655440000
        error:
          type: string
          description: Error message if the transcode failed
          example: Transcode failed due to insufficient resources

    HeartbeatTranscodeActivityRequest:
      type: object
      required:
        - token
        - progress
      properties:
        token:
          type: string
          format: byte
          description: Base64-encoded binary token
          example: dGVzdC10b2tlbi1kYXRh
        uuid:
          type: string
          format: uuid
          description: UUID that was used to start the transcode.
          example: 550e8400-e29b-41d4-a716-446655440000
        progress:
          type: number
          format: double
          minimum: 0
          maximum: 100
          description: Completion percentage (0-100)
          example: 75.0
    
    CreateDiscRequest:
      type: object
      required:
        - uuid
        - path
      properties:
        uuid:
          type: string
          format: uuid
          description: Client-provided UUID for the disc workflow
          example: 550e8400-e29b-41d4-a716-446655440000
        path:
          type: string
          description: Path to the directory containing the disc contents
          example: /mnt/discs/disc001

    DiscWorkflowFile:
      type: object
      required:
        - filename
      properties:
        filename:
          type: string
          example: video.mp4
        previewPath:
          type: string
          example: /nas/media/previews/video_preview.mp4
          description: Path to the generated preview video for the video file.
        durationSeconds:
          type: number
          format: double
          example: 3600.5
          description: Duration of the video file in seconds.
        chapterDurationsSeconds:
          type: array
          items:
            type: number
            format: double
          description: List of chapter durations in seconds.
          example: [600.0, 1200.0, 1800.5]
    
    DiscWorkflow:
      type: object
      required:
        - uuid
        - status
      properties:
        uuid:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        status:
          type: string
          example: created
        files:
          type: array
          items:
            $ref: '#/components/schemas/DiscWorkflowFile'
          description: List of files being processed by the disc workflow.
        error:
          type: string
          description: Error message if the workflow failed
          example: Failed to process disc
    
    InboxResponse:
      type: object
      required:
        - paths
      properties:
        paths:
          type: array
          items:
            type: string
          description: List of disc paths in the inbox
          example: ["/mnt/discs/disc001", "/mnt/discs/disc002", "/mnt/discs/disc003"]
    
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          example: INTERNAL_ERROR
        message:
          type: string
          example: An error occurred
